<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Minecraft Command Generator Pro (Fixed)</title>
    <style>
        /* Base styles */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0; 
            margin: 0;
            background-color: #f0f2f5;
            color: #1c1e21;
            overscroll-behavior-y: contain;
            height: 100vh;
            width: 100vw;
            overflow: hidden; 
        }
        #main-container {
            width: 100%;
            max-width: 500px; 
            margin: 0 auto; 
            display: flex;
            flex-direction: column;
            height: 100%; 
            box-sizing: border-box;
            padding: 10px; 
        }
        #command-display-area {
            background-color: #fff;
            border: 1px solid #ccd0d5;
            border-radius: 8px;
            padding: 8px;
            margin-bottom: 10px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            flex-shrink: 0; 
        }
        #command-built-area {
            flex-grow: 1;
            min-height: 48px;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 4px;
            overflow-y: auto;
            max-height: 100px;
            padding-bottom: 5px; 
        }
        .command-part-btn, .command-part-char-display, .command-part-input-wrapper input {
            padding: 6px 10px;
            background-color: #e4e6eb;
            color: #050505;
            border: 1px solid #d1d3d6;
            border-radius: 15px;
            font-size: 0.9em;
            position: relative; 
            box-sizing: border-box;
            line-height: 1.2;
            white-space: nowrap;
        }
        .command-part-btn {
            cursor: pointer;
        }
        .command-part-btn:hover { background-color: #d8dbdf; }

        .command-part-char-display {
            background-color: #f0f2f5;
            cursor: default;
            padding: 6px 8px;
        }
        
        .command-part-input-wrapper {
            display: inline-block;
            padding: 0; margin:0; border:none; background:none;
        }
        .command-part-input-wrapper input {
            background-color: #fff;
            border: 1px solid #1b74e4;
            min-width: 60px;
            max-width: 150px;
            outline: none;
        }


        .change-popup { 
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333; color: white; padding: 5px 10px;
            border-radius: 4px; z-index: 1000; cursor: pointer; font-size: 0.8em;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            white-space: nowrap;
        }

        #copy-button {
            padding: 12px 15px; margin-left: 8px; background-color: #1b74e4;
            color: white; border: none; border-radius: 6px; cursor: pointer;
            font-size: 0.9em; font-weight: bold;
        }
        #copy-button:hover { background-color: #155bd8; } 

        .button-panels-container { 
            flex-grow: 1;
            overflow-y: auto;
            background-color: #ffffff;
            border: 1px solid #ccd0d5;
            border-radius: 8px;
            padding: 10px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .button-panel { margin-bottom: 15px; }
        .button-panel h3 {
            margin-top: 0; margin-bottom: 10px; font-size: 1.1em; color: #606770;
            border-bottom: 1px solid #e4e6eb; padding-bottom: 5px;
        }

        .panel-button-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 8px;
        }
        .panel-button-list { display: flex; flex-direction: column; gap: 8px; }

        .panel-button { 
            padding: 12px 10px; background-color: #f0f2f5; color: #050505;
            border: 1px solid #d1d3d6; border-radius: 6px; cursor: pointer;
            text-align: center; font-size: 0.95em; transition: background-color 0.2s;
        }
        .panel-button:hover { background-color: #e4e6eb; }
        .panel-button.primary { background-color: #1b74e4; color: white; font-weight: bold; }
        .panel-button.primary:hover { background-color: #155bd8; } 

        .fullscreen-list-container {
            position: fixed; 
            top: 0; left: 0; width: 100vw; height: 100vh;
            background-color: #fff;
            z-index: 2000; 
            padding: 10px;
            box-sizing: border-box;
            overflow-y: auto; 
            display: flex; 
            flex-wrap: wrap; 
            gap: 6px; 
            align-content: flex-start; 
        }
        .fullscreen-list-container .list-item-button { 
            padding: 6px 12px;
            background-color: #e4e6eb;
            color: #050505;
            border: 1px solid #d1d3d6;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.9em;
        }
         .fullscreen-list-container .list-item-button:hover { background-color: #d8dbdf; }
         .fullscreen-list-header { 
            width: 100%;
            padding: 10px 0;
            font-size: 1.2em;
            font-weight: bold;
            text-align: center;
            margin-bottom: 10px;
            flex-basis: 100%; 
         }
         .fullscreen-list-back-button {
            position: fixed;
            top: 15px; right: 15px;
            z-index: 2001; 
            padding: 8px 12px;
            background-color: #050505;
            color: white;
            border: none;
            border-radius: 50%; 
            font-size: 1em;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
         }

        #keypad-container {
            position: fixed; bottom: 0; left: 0; right: 0;
            background-color: #d1d3d6; padding: 10px; border-top: 1px solid #b0b3b8;
            box-shadow: 0 -2px 5px rgba(0,0,0,0.1); z-index: 1000;
            display: none; 
            grid-template-columns: repeat(4, 1fr); gap: 5px;
        }
        #keypad-container button {
            padding: 15px 10px; font-size: 1.2em; background-color: #f0f2f5;
            border: 1px solid #b0b3b8; border-radius: 5px; cursor: pointer;
        }
        #keypad-container button:active { background-color: #b0b3b8; }
        #keypad-display {
            grid-column: span 4; background-color: #fff; border: 1px solid #b0b3b8;
            padding: 10px; text-align: right; font-size: 1.2em; margin-bottom: 5px; min-height: 24px;
        }

        .button-panel:not(#panel-initial) { display: none; }
        .fullscreen-list-container { display: none; } 

    </style>
</head>
<body>
    <div id="main-container">
        <div id="command-display-area">
            <div id="command-built-area"></div>
            <button id="copy-button">Copy</button>
        </div>

        <div class="button-panels-container">
            <div id="panel-initial" class="button-panel">
                <div class="panel-button-list">
                    <button id="start-execute-button" class="panel-button primary">Start with /execute</button>
                </div>
            </div>

            <div id="panel-execute-subcommands" class="button-panel">
                <h3>Execute Subcommands</h3>
                <div class="panel-button-grid">
                    <button class="panel-button" data-subcommand="as">as</button>
                    <button class="panel-button" data-subcommand="at">at</button>
                    <button class="panel-button" data-subcommand="in">in</button>
                    <button class="panel-button" data-subcommand="positioned">positioned</button>
                    <button class="panel-button" data-subcommand="align">align</button>
                    <button class="panel-button" data-subcommand="anchored">anchored</button>
                    <button class="panel-button" data-subcommand="rotated">rotated</button>
                    <button class="panel-button" data-subcommand="facing">facing</button>
                    <button class="panel-button" data-subcommand="if">if</button>
                    <button class="panel-button" data-subcommand="unless">unless</button>
                    <button class="panel-button primary" data-subcommand="run">run</button>
                </div>
            </div>

            <div id="panel-targets" class="button-panel">
                <h3>Target Selectors</h3>
                <div class="panel-button-grid">
                    <button class="panel-button" data-selector="@p">@p</button>
                    <button class="panel-button" data-selector="@r">@r</button>
                    <button class="panel-button" data-selector="@a">@a</button>
                    <button class="panel-button" data-selector="@s">@s</button>
                    <button class="panel-button" data-selector="@e">@e</button>
                    <button class="panel-button" data-action="manual-selector-entry">[Type Selector/Name]</button>
                </div>
            </div>
            
            <div id="panel-selector-activated" class="button-panel">
                <h3>Selector Active: <span id="current-active-selector-display" style="font-weight:bold;"></span></h3>
                <section>
                    <h4>Add Argument</h4>
                    <div id="selector-args-options-container" class="panel-button-grid">
                        <button class="panel-button" data-selector-arg-key="type">type=</button>
                        <button class="panel-button" data-selector-arg-key="name">name=</button>
                        <button class="panel-button" data-selector-arg-key="tag">tag=</button>
                        <button class="panel-button" data-selector-arg-key="limit">limit=</button>
                        </div>
                </section>
                <hr style="margin: 15px 0;">
                <section>
                    <h4>Or Continue With Next Subcommand</h4>
                    <div id="selector-next-execute-options-container" class="panel-button-grid">
                        </div>
                </section>
            </div>
            
            <div id="panel-dimensions" class="button-panel">
                 <h3>Dimension</h3>
                 <div class="panel-button-grid">
                    <button class="panel-button" data-dimension="overworld">overworld</button>
                    <button class="panel-button" data-dimension="the_nether">the_nether</button>
                    <button class="panel-button" data-dimension="the_end">the_end</button>
                </div>
            </div>

        </div> 
    </div> 
    
    <div id="fullscreen-entity-list" class="fullscreen-list-container">
        <button class="fullscreen-list-back-button" data-action="close-fullscreen-list">X</button>
        <h3 class="fullscreen-list-header">Select Entity Type</h3>
    </div>

    <div id="fullscreen-run-command-list" class="fullscreen-list-container">
        <button class="fullscreen-list-back-button" data-action="close-fullscreen-list">X</button>
        <h3 class="fullscreen-list-header">Choose Command to Run</h3>
    </div>

    <div id="keypad-container">
        <input type="text" id="keypad-display" readonly placeholder="0">
        <button data-key="7">7</button> <button data-key="8">8</button> <button data-key="9">9</button> <button data-key="~">~</button>
        <button data-key="4">4</button> <button data-key="5">5</button> <button data-key="6">6</button> <button data-key=".">.</button>
        <button data-key="1">1</button> <button data-key="2">2</button> <button data-key="3">3</button> <button data-key="-">-</button>
        <button data-key=" " style="font-size: 0.8em;">Spc</button> <button data-key="0">0</button> <button data-key="backspace" style="font-size: 0.8em;">DEL</button> <button data-key="enter" style="font-size: 0.8em;" class="primary">OK</button>
    </div>

    <script>
        // --- DATA STORE ---
        const MINECRAFT_ENTITIES = ["allay", "armor_stand", "arrow", "axolotl", "bat", "bee", "blaze", "boat", "cat", "cave_spider", "chest_boat", "chicken", "cod", "cow", "creeper", "dolphin", "donkey", "drowned", "egg", "elder_guardian", "end_crystal", "ender_dragon", "ender_pearl", "enderman", "endermite", "evoker", "experience_bottle", "experience_orb", "eye_of_ender", "falling_block", "fireball", "firework_rocket", "fishing_bobber", "fox", "frog", "ghast", "glow_item_frame", "glow_squid", "goat", "guardian", "hoglin", "horse", "husk", "iron_golem", "item", "item_frame", "leash_knot", "lightning_bolt", "llama", "magma_cube", "minecart", "mooshroom", "mule", "ocelot", "painting", "panda", "parrot", "phantom", "pig", "piglin", "pillager", "player", "polar_bear", "pufferfish", "rabbit", "ravager", "salmon", "sheep", "shulker", "silverfish", "skeleton", "skeleton_horse", "slime", "snow_golem", "snowball", "spider", "squid", "stray", "strider", "tadpole", "tnt", "trader_llama", "tropical_fish", "turtle", "vex", "villager", "vindicator", "wandering_trader", "warden", "witch", "wither", "wither_skeleton", "wolf", "zoglin", "zombie", "zombie_horse", "zombie_villager", "zombified_piglin"];
        const RUN_COMMANDS_LIST = [
            { id: "say", name: "say", handler: "handleSayCommand" },
            { id: "tp", name: "tp", handler: "handleTpCommand" },
            { id: "summon", name: "summon", handler: "handleSummonCommand" },
            { id: "give", name: "give", handler: "handleGiveCommand" },
            { id: "effect", name: "effect", handler: "handleEffectCommand" },
            { id: "gamemode", name: "gamemode", handler: "handleGamemodeCommand" },
            { id: "kill", name: "kill", handler: "handleKillCommand" },
            { id: "setblock", name: "setblock", handler: "handleSetblockCommand" },
            { id: "fill", name: "fill", handler: "handleFillCommand" },
            { id: "scoreboard", name: "scoreboard", handler: "handleScoreboardCommand" },
            { id: "tag", name: "tag", handler: "handleTagCommand" },
        ];

        // --- DOM ELEMENTS ---
        const commandBuiltArea = document.getElementById('command-built-area');
        const allPanels = document.querySelectorAll('.button-panel'); // *** FIXED: MOVED HERE ***
        const copyButton = document.getElementById('copy-button');
        const mainPanelsContainer = document.querySelector('.button-panels-container');
        const fullscreenEntityList = document.getElementById('fullscreen-entity-list');
        const fullscreenRunCommandList = document.getElementById('fullscreen-run-command-list');
        const currentActiveSelectorDisplay = document.getElementById('current-active-selector-display');
        const selectorArgsOptionsContainer = document.getElementById('selector-args-options-container');
        const selectorNextExecuteOptionsContainer = document.getElementById('selector-next-execute-options-container');
        const keypadContainer = document.getElementById('keypad-container');
        const keypadDisplay = document.getElementById('keypad-display');

        // --- STATE ---
        let commandParts = [];
        let currentPanelId = 'panel-initial';
        let activeInputTargetElement = null;
        let activeInputTarget = null;
        let pendingSelector = null; 
        let selectorArgState = {
            isActive: false,
            baseSelectorPartId: null,
            hasOpenBracket: false
        };

        // --- INITIALIZATION ---
        function initialize() {
            showPanel('panel-initial'); 
            hideFullscreenLists();    
            populateRunCommandListForFullscreen(); 
            populateEntityListForFullscreen();     
            const execSubcommandsPanelGrid = document.getElementById('panel-execute-subcommands').querySelector('.panel-button-grid');
            if (execSubcommandsPanelGrid) {
                selectorNextExecuteOptionsContainer.innerHTML = execSubcommandsPanelGrid.innerHTML;
            }
            setupEventListeners(); 
        }
        
        // --- Fullscreen List Management ---
        function hideFullscreenLists() {
            fullscreenEntityList.style.display = 'none';
            fullscreenRunCommandList.style.display = 'none';
        }

        function showFullscreenList(listId, context = {}) {
            allPanels.forEach(panel => panel.style.display = 'none');
            hideFullscreenLists(); 
            if (listId === 'fullscreen-entity-list') fullscreenEntityList.style.display = 'flex';
            if (listId === 'fullscreen-run-command-list') fullscreenRunCommandList.style.display = 'flex';
            mainPanelsContainer.style.display = 'none'; 
        }

        function hideCurrentFullscreenListAndShowPanel(panelId) {
            hideFullscreenLists();
            mainPanelsContainer.style.display = 'block'; 
            if (panelId) {
                showPanel(panelId);
            } else {
                showPanel(currentPanelId || 'panel-initial');
            }
        }
        
        function populateListForFullscreen(container, list, textProp, dataProp, clickHandler) {
             container.querySelectorAll('.list-item-button').forEach(btn => btn.remove());
             list.forEach(item => {
                const button = document.createElement('button');
                button.className = 'list-item-button';
                button.textContent = item[textProp];
                button.dataset[dataProp] = item.id || item;
                button.addEventListener('click', () => clickHandler(item));
                container.appendChild(button);
            });
        }
        
        function populateEntityListForFullscreen() {
            const container = fullscreenEntityList; 
            container.querySelectorAll('.list-item-button').forEach(btn => btn.remove());
            MINECRAFT_ENTITIES.sort().forEach(entity => {
                const button = document.createElement('button');
                button.className = 'list-item-button';
                button.textContent = entity;
                button.dataset.entityType = entity;
                button.addEventListener('click', () => handleEntityTypeSelection(entity));
                container.appendChild(button);
            });
        }
        
        function populateRunCommandListForFullscreen() {
             const container = fullscreenRunCommandList;
            container.querySelectorAll('.list-item-button').forEach(btn => btn.remove());
            RUN_COMMANDS_LIST.forEach(cmd => {
                const button = document.createElement('button');
                button.className = 'list-item-button';
                button.textContent = cmd.name;
                button.dataset.runCommand = cmd.id;
                button.addEventListener('click', () => handleRunCommandSelection(cmd));
                container.appendChild(button);
            });
        }

        // --- Panel Management ---
        function showPanel(panelId) {
            if (!allPanels) {
                console.error("allPanels is not defined!");
                return;
            }
            allPanels.forEach(panel => panel.style.display = 'none');
            const panelToShow = document.getElementById(panelId);
            if (panelToShow) {
                panelToShow.style.display = 'block';
                currentPanelId = panelId;
            } else {
                console.warn("Panel not found:", panelId, "defaulting to panel-initial");
                document.getElementById('panel-initial').style.display = 'block';
                currentPanelId = 'panel-initial';
            }
            if (keypadContainer) keypadContainer.style.display = 'none';
        }

        // --- COMMAND BUILDING ---
        function addCommandSegment(text, type, options = {}) {
            const segment = {
                id: `cmd-part-${Date.now()}-${Math.random().toString(36).substr(2, 5)}`,
                text: text,
                type: type,
                isEditableInput: options.isEditableInput || false,
                placeholder: options.placeholder || "",
                requiresInput: options.requiresInput || null,
                sourcePanelId: currentPanelId,
                ...options
            };
            commandParts.push(segment);
            renderCommandBuiltArea();
            
            if (segment.isEditableInput && segment.requiresInput === 'keypad') {
                const inputElement = commandBuiltArea.querySelector(`input[data-part-id="${segment.id}"]`);
                if (inputElement) prepareKeypadForInput(inputElement, segment);
            } else if (segment.isEditableInput) {
                 const inputElement = commandBuiltArea.querySelector(`input[data-part-id="${segment.id}"]`);
                 if (inputElement) {
                    inputElement.focus();
                    inputElement.scrollIntoView({behavior: "smooth", block: "nearest"});
                 }
            }
             return segment; // Return the created segment for reference
        }

        function renderCommandBuiltArea() {
            commandBuiltArea.innerHTML = '';
            commandParts.forEach((part, index) => {
                let element;
                if (part.isEditableInput) {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'command-part-input-wrapper';
                    element = document.createElement('input');
                    element.type = 'text';
                    element.value = part.text;
                    element.placeholder = part.placeholder || 'value';
                    element.dataset.partId = part.id;
                    element.dataset.partIndex = index;
                    element.addEventListener('input', (e) => {
                        part.text = e.target.value;
                    });
                    if (part.requiresInput === 'keypad') {
                        element.readOnly = true;
                        element.addEventListener('focus', () => prepareKeypadForInput(element, part));
                         element.addEventListener('click', () => prepareKeypadForInput(element, part));
                    }
                    wrapper.appendChild(element);
                    commandBuiltArea.appendChild(wrapper);
                } else if (['bracket_open', 'bracket_close', 'comma'].includes(part.type)) {
                    element = document.createElement('span');
                    element.className = 'command-part-char-display';
                    element.textContent = part.text;
                    element.dataset.partId = part.id;
                    element.dataset.partIndex = index;
                    commandBuiltArea.appendChild(element);
                } else {
                    element = document.createElement('button');
                    element.className = 'command-part-btn';
                    element.textContent = part.text;
                    element.dataset.partId = part.id;
                    element.dataset.partIndex = index;
                    element.addEventListener('click', (e) => {
                        e.stopPropagation(); 
                        showChangeOption(element, part.id, index);
                    });
                    commandBuiltArea.appendChild(element);
                }
            });
        }
        
        // --- Change Popup Logic ---
        let currentChangePopup = null;
        function showChangeOption(parentButton, partId, index) {
            if (['bracket_open', 'bracket_close', 'comma'].includes(commandParts[index].type)) return;

            if (currentChangePopup) {
                currentChangePopup.remove();
                currentChangePopup = null;
            }
            const popup = document.createElement('div'); 
            popup.className = 'change-popup';
            popup.textContent = 'Change';
            
            popup.addEventListener('click', (e) => {
                e.stopPropagation();
                handleChangeCommandPart(index); 
                if (popup.parentNode) popup.remove();
                currentChangePopup = null;
            });

            const parentWrapper = parentButton.closest('.command-part-input-wrapper') || parentButton;
            parentWrapper.style.position = 'relative'; 
            parentWrapper.appendChild(popup);
            currentChangePopup = popup;

            const parentRect = parentWrapper.getBoundingClientRect();
            const containerRect = commandBuiltArea.getBoundingClientRect(); 
            const popupRect = popup.getBoundingClientRect();

            if (parentRect.bottom - containerRect.top + popupRect.height + 5 > containerRect.height) {
                popup.style.bottom = 'auto';
                popup.style.top = `-${popupRect.height + 2}px`; 
            } else {
                popup.style.top = 'auto';
                popup.style.bottom = `-${popupRect.height + 2}px`; 
            }
            
            setTimeout(() => { 
                 document.body.addEventListener('click', () => {
                    if(currentChangePopup && currentChangePopup.parentNode) currentChangePopup.remove();
                    currentChangePopup = null;
                 }, { once: true });
            }, 0);
        }

        function handleChangeCommandPart(index) {
            // This logic needs to be carefully implemented to handle removal of parts
            // and their associated commas/brackets correctly.
            console.log("Change requested for part at index:", index, commandParts[index]);
            // For now, simple truncation for demonstration
             commandParts = commandParts.slice(0, index);
             renderCommandBuiltArea();
             // A more robust implementation would reset state and show the correct panel.
             showPanel('panel-execute-subcommands'); // Simple fallback
        }

        // --- Keypad ---
        function prepareKeypadForInput(inputElement, partData) { /* ... same as before ... */ }
        function setupKeypadListeners() { /* ... same as before ... */ }
        function handleKeypadInput(key) { /* ... same as before ... */ }

        // --- EVENT LISTENERS SETUP ---
        function setupEventListeners() {
            // Start Execute Button
            document.getElementById('start-execute-button').addEventListener('click', () => {
                commandParts = []; 
                pendingSelector = null; 
                selectorArgState = { isActive: false, baseSelectorPartId: null, hasOpenBracket: false };
                addCommandSegment('/execute', 'keyword', {sourcePanelId: 'panel-initial'});
                showPanel('panel-execute-subcommands');
            });
            
            // --- Panel Targets (Selectors like @e) ---
            document.querySelectorAll('#panel-targets .panel-button[data-selector]').forEach(button => {
                button.addEventListener('click', () => {
                    pendingSelector = button.dataset.selector;
                    selectorArgState = { isActive: false, baseSelectorPartId: null, hasOpenBracket: false }; 
                    currentActiveSelectorDisplay.textContent = pendingSelector;
                    const execSubcommandsPanelGrid = document.getElementById('panel-execute-subcommands').querySelector('.panel-button-grid');
                    if (execSubcommandsPanelGrid) {
                        selectorNextExecuteOptionsContainer.innerHTML = execSubcommandsPanelGrid.innerHTML;
                        attachListenersToSelectorNextExecuteOptions();
                    }
                    showPanel('panel-selector-activated');
                });
            });

            // --- Panel Selector Activated ---
            document.querySelectorAll('#selector-args-options-container .panel-button[data-selector-arg-key]').forEach(button => {
                button.addEventListener('click', () => {
                    if (!pendingSelector) return; 

                    if (!selectorArgState.isActive) {
                        const baseSelPart = addCommandSegment(pendingSelector, 'selector_base');
                        selectorArgState.baseSelectorPartId = baseSelPart.id;
                        addCommandSegment('[', 'bracket_open');
                        selectorArgState.isActive = true;
                        selectorArgState.hasOpenBracket = true;
                    } else {
                        addCommandSegment(',', 'comma');
                    }
                    
                    const argKeyText = button.dataset.selectorArgKey;
                    addCommandSegment(argKeyText, 'selector_arg_key');

                    if (argKeyText === 'type') {
                        activeInputTarget = { forArgKey: 'type=' }; 
                        showFullscreenList('fullscreen-entity-list');
                    } else if (argKeyText === 'limit') {
                        addCommandSegment('', 'selector_arg_value_input', {isEditableInput:true, placeholder:'number', requiresInput:'keypad', nextPanelAfterInput:'panel-selector-activated'});
                    } else { 
                        addCommandSegment('', 'selector_arg_value_input', {isEditableInput:true, placeholder:'value', nextPanelAfterInput:'panel-selector-activated'});
                    }
                });
            });

            function attachListenersToSelectorNextExecuteOptions() {
                selectorNextExecuteOptionsContainer.querySelectorAll('.panel-button[data-subcommand]').forEach(button => {
                    const newButton = button.cloneNode(true);
                    button.parentNode.replaceChild(newButton, button);
                    newButton.addEventListener('click', () => {
                        handleNextExecuteSubcommandFromSelectorPanel(newButton.dataset.subcommand);
                    });
                });
            }

            function handleNextExecuteSubcommandFromSelectorPanel(subcommandName) {
                if (!pendingSelector) return;
                if (selectorArgState.isActive && selectorArgState.hasOpenBracket) { 
                    addCommandSegment(']', 'bracket_close');
                } else {
                    addCommandSegment(pendingSelector, 'selector_base');
                }
                addCommandSegment(subcommandName, 'keyword'); 
                pendingSelector = null; 
                selectorArgState = { isActive: false, baseSelectorPartId: null, hasOpenBracket: false };
                const nextPanel = getNextPanelForExecuteSubcommand(subcommandName);
                if (nextPanel) showPanel(nextPanel);
            }

            document.querySelectorAll('#panel-execute-subcommands .panel-button[data-subcommand]').forEach(button => {
                 button.addEventListener('click', () => {
                    const subcommand = button.dataset.subcommand;
                    if (selectorArgState.isActive) {
                        addCommandSegment(']', 'bracket_close');
                    }
                    selectorArgState = { isActive: false, baseSelectorPartId: null, hasOpenBracket: false };
                    pendingSelector = null;
                    addCommandSegment(subcommand, 'keyword');
                    const nextPanel = getNextPanelForExecuteSubcommand(subcommand);
                    if (nextPanel) showPanel(nextPanel);
                 });
            });
            
            // --- Fullscreen List Back Buttons ---
            document.querySelectorAll('.fullscreen-list-back-button').forEach(button => {
                button.addEventListener('click', () => {
                    let targetPanel = 'panel-execute-subcommands';
                    if (selectorArgState.isActive) {
                        targetPanel = 'panel-selector-activated';
                    }
                    hideCurrentFullscreenListAndShowPanel(targetPanel);
                    activeInputTarget = null; 
                });
            });
            
             // --- Copy Button ---
            copyButton.addEventListener('click', () => {
                const commandText = commandParts.map(part => part.text).join(' ').replace(/ , /g, ',').replace(/ \[ /g, '[').replace(/ \] /g, ']');
                navigator.clipboard.writeText(commandText)
                    .then(() => alert('Command copied: ' + commandText))
                    .catch(err => console.error('Failed to copy: ', err));
            });

            // Initial attachment of listeners
            attachListenersToSelectorNextExecuteOptions();

        } // End setupEventListeners
        
        // --- Specific Handlers ---
        function getNextPanelForExecuteSubcommand(subcommand) {
            switch (subcommand) {
                case 'as': case 'at': return 'panel-targets';
                case 'in': return 'panel-dimensions';
                case 'run': showFullscreenList('fullscreen-run-command-list'); return currentPanelId;
                case 'positioned': case 'rotated': case 'facing':
                    addCommandSegment('', 'coordinates_input', { isEditableInput: true, placeholder: 'x y z', requiresInput: 'keypad', nextPanelAfterInput: 'panel-execute-subcommands'});
                    return currentPanelId;
                case 'align':
                    addCommandSegment('', 'text_input', { isEditableInput: true, placeholder: 'xyz', nextPanelAfterInput: 'panel-execute-subcommands' });
                    return currentPanelId;
                default: return 'panel-execute-subcommands'; 
            }
        }
        
        function handleEntityTypeSelection(entityType) {
            if (activeInputTarget && activeInputTarget.forArgKey === 'type=') {
                addCommandSegment(entityType, 'selector_arg_value'); 
                activeInputTarget = null;
                hideCurrentFullscreenListAndShowPanel('panel-selector-activated');
            } else if (commandParts.length > 0 && commandParts[commandParts.length - 1].type === 'keyword' && commandParts[commandParts.length - 1].text === 'summon') {
                addCommandSegment(entityType, 'entity_type_for_summon');
                addCommandSegment('', 'coordinates_input', { isEditableInput: true, placeholder:'x y z', requiresInput:'keypad', nextPanelAfterInput:'panel-execute-subcommands' });
                hideCurrentFullscreenListAndShowPanel(null); // Keypad will show
                keypadContainer.style.display = 'grid'; // Manually show keypad
            } else {
                console.warn("Entity type selected out of context.");
                hideCurrentFullscreenListAndShowPanel('panel-execute-subcommands');
            }
        }

        function handleRunCommandSelection(commandInfo) {
            addCommandSegment(commandInfo.id, 'run_command_name');
            pendingSelector = null; 
            selectorArgState = { isActive: false, baseSelectorPartId: null, hasOpenBracket: false }; 

            if (commandInfo.handler === 'handleSummonCommand') {
                activeInputTarget = null; 
                hideCurrentFullscreenListAndShowPanel(null); 
                showFullscreenList('fullscreen-entity-list'); 
            } else if (commandInfo.handler === 'handleSayCommand') {
                 addCommandSegment('', 'text_input', {isEditableInput:true, placeholder:'message', nextPanelAfterInput:'panel-execute-subcommands'});
                 hideCurrentFullscreenListAndShowPanel('panel-execute-subcommands'); 
            } else if (typeof commandInfo.handler === 'string' && commandInfo.handler.startsWith('panel-')) {
                hideCurrentFullscreenListAndShowPanel(commandInfo.handler);
            } else {
                hideCurrentFullscreenListAndShowPanel('panel-execute-subcommands'); 
            }
        }

        // --- START THE APP ---
        initialize();
    </script>
</body>
</html>
