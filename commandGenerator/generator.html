<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Minecraft Command Generator Enhanced</title>
    <style>
        /* Base styles from previous version, with modifications */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0; /* Remove body padding for full-screen elements */
            margin: 0;
            background-color: #f0f2f5;
            color: #1c1e21;
            overscroll-behavior-y: contain;
            height: 100vh;
            width: 100vw;
            overflow: hidden; /* Prevent body scroll when panels manage their own */
        }
        #main-container {
            width: 100%;
            max-width: 500px; /* Maintain mobile-first focus for main content */
            margin: 0 auto; /* Center main container */
            display: flex;
            flex-direction: column;
            height: 100%; /* Full viewport height */
            box-sizing: border-box;
            padding: 10px; /* Padding for the content within main-container */
        }
        #command-display-area {
            background-color: #fff;
            border: 1px solid #ccd0d5;
            border-radius: 8px;
            padding: 8px;
            margin-bottom: 10px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            flex-shrink: 0; /* Prevent shrinking */
        }
        #command-built-area {
            flex-grow: 1;
            min-height: 48px;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 4px;
            overflow-y: auto;
            max-height: 96px; /* Allow for 2 rows of buttons before scroll */
        }
        .command-part-btn {
            padding: 6px 10px;
            background-color: #e4e6eb;
            color: #050505;
            border: 1px solid #d1d3d6;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.9em;
            position: relative; /* For the 'change' popup */
        }
        .command-part-btn:hover { background-color: #d8dbdf; }

        .command-part-input { /* For actual text input fields if needed */
            padding: 6px 8px; border: 1px solid #1b74e4; border-radius: 4px;
            font-size: 0.9em; min-width: 80px;
        }

        .change-popup { /* JS will need to check bounds */
            position: absolute;
            /* bottom: -30px; Default, JS can flip to top */
            left: 50%;
            transform: translateX(-50%);
            background-color: #333; color: white; padding: 5px 10px;
            border-radius: 4px; z-index: 1000; cursor: pointer; font-size: 0.8em;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        #copy-button {
            padding: 12px 15px; margin-left: 8px; background-color: #1b74e4;
            color: white; border: none; border-radius: 6px; cursor: pointer;
            font-size: 0.9em; font-weight: bold;
        }
        #copy-button:hover { background-color: #155 कागज; }

        .button-panels-container { /* This is the main area for choice buttons */
            flex-grow: 1;
            overflow-y: auto;
            background-color: #ffffff;
            border: 1px solid #ccd0d5;
            border-radius: 8px;
            padding: 10px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .button-panel { margin-bottom: 15px; }
        .button-panel h3 {
            margin-top: 0; margin-bottom: 10px; font-size: 1.1em; color: #606770;
            border-bottom: 1px solid #e4e6eb; padding-bottom: 5px;
        }

        /* Standard button grid for panels */
        .panel-button-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 8px;
        }
        /* Standard button list for panels */
        .panel-button-list { display: flex; flex-direction: column; gap: 8px; }

        .panel-button { /* Default wide buttons */
            padding: 12px 10px; background-color: #f0f2f5; color: #050505;
            border: 1px solid #d1d3d6; border-radius: 6px; cursor: pointer;
            text-align: center; font-size: 0.95em; transition: background-color 0.2s;
        }
        .panel-button:hover { background-color: #e4e6eb; }
        .panel-button.primary { background-color: #1b74e4; color: white; font-weight: bold; }
        .panel-button.primary:hover { background-color: #155 कागज; }

        /* Full-screen list container styles */
        .fullscreen-list-container {
            position: fixed; /* Take over screen */
            top: 0; left: 0; width: 100vw; height: 100vh;
            background-color: #fff;
            z-index: 2000; /* Above everything */
            padding: 10px;
            box-sizing: border-box;
            overflow-y: auto; /* Scroll if content overflows */
            display: flex; /* For flex-wrap */
            flex-wrap: wrap; /* Allow buttons to wrap */
            gap: 6px; /* Spacing for small buttons */
            align-content: flex-start; /* Start items from top */
        }
        .fullscreen-list-container .list-item-button { /* Small, pill-shaped buttons for lists */
            padding: 6px 12px;
            background-color: #e4e6eb;
            color: #050505;
            border: 1px solid #d1d3d6;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.9em;
            /* No min-width, let them size to content */
        }
         .fullscreen-list-container .list-item-button:hover { background-color: #d8dbdf; }
         .fullscreen-list-header { /* Optional header for full-screen lists */
            width: 100%;
            padding: 10px 0;
            font-size: 1.2em;
            font-weight: bold;
            text-align: center;
            margin-bottom: 10px;
            flex-basis: 100%; /* Take full width */
         }
         .fullscreen-list-back-button {
            position: fixed;
            top: 15px; right: 15px;
            z-index: 2001; /* Above the list content */
            padding: 8px 12px;
            background-color: #050505;
            color: white;
            border: none;
            border-radius: 50%; /* Circular */
            font-size: 1em;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
         }


        /* Keypad Styles (as before) */
        #keypad-container {
            position: fixed; bottom: 0; left: 0; right: 0;
            background-color: #d1d3d6; padding: 10px; border-top: 1px solid #b0b3b8;
            box-shadow: 0 -2px 5px rgba(0,0,0,0.1); z-index: 1000;
            display: none; /* Hidden initially */
            grid-template-columns: repeat(4, 1fr); gap: 5px;
        }
        #keypad-container button {
            padding: 15px 10px; font-size: 1.2em; background-color: #f0f2f5;
            border: 1px solid #b0b3b8; border-radius: 5px; cursor: pointer;
        }
        #keypad-container button:active { background-color: #b0b3b8; }
        #keypad-display {
            grid-column: span 4; background-color: #fff; border: 1px solid #b0b3b8;
            padding: 10px; text-align: right; font-size: 1.2em; margin-bottom: 5px; min-height: 24px;
        }

        /* Initial hide for panels not active */
        .button-panel:not(#panel-initial) { display: none; }
        .fullscreen-list-container { display: none; } /* Hidden initially */

    </style>
</head>
<body>
    <div id="main-container">
        <div id="command-display-area">
            <div id="command-built-area"></div>
            <button id="copy-button">Copy</button>
        </div>

        <div class="button-panels-container">
            <div id="panel-initial" class="button-panel">
                <div class="panel-button-list">
                    <button id="start-execute-button" class="panel-button primary" data-command-part="/execute">Start with /execute</button>
                </div>
            </div>

            <div id="panel-execute-subcommands" class="button-panel">
                <h3>Execute Subcommands</h3>
                <div class="panel-button-grid">
                    <button class="panel-button" data-subcommand="as">as</button>
                    <button class="panel-button" data-subcommand="at">at</button>
                    <button class="panel-button" data-subcommand="in">in</button>
                    <button class="panel-button" data-subcommand="positioned">positioned</button>
                    <button class="panel-button" data-subcommand="align">align</button>
                    <button class="panel-button" data-subcommand="anchored">anchored</button>
                    <button class="panel-button" data-subcommand="rotated">rotated</button>
                    <button class="panel-button" data-subcommand="facing">facing</button>
                    <button class="panel-button" data-subcommand="if">if</button>
                    <button class="panel-button" data-subcommand="unless">unless</button>
                    <button class="panel-button primary" data-subcommand="run">run</button>
                </div>
            </div>

            <div id="panel-targets" class="button-panel">
                <h3>Target Selectors</h3>
                <div class="panel-button-grid">
                    <button class="panel-button" data-selector="@p">@p</button>
                    <button class="panel-button" data-selector="@r">@r</button>
                    <button class="panel-button" data-selector="@a">@a</button>
                    <button class="panel-button" data-selector="@s">@s</button>
                    <button class="panel-button" data-selector="@e">@e</button>
                    <button class="panel-button" data-action="manual-selector-entry">[Type Selector/Name]</button>
                </div>
            </div>
            
            <div id="panel-selector-activated" class="button-panel">
                <h3>Selector Active: Add Argument or Continue</h3>
                <div id="current-active-selector-display" style="margin-bottom:10px; font-weight:bold;"></div>
                
                <section>
                    <h4>Selector Arguments</h4>
                    <div id="selector-args-options-container" class="panel-button-grid">
                        <button class="panel-button" data-selector-arg="type">type=</button>
                        <button class="panel-button" data-selector-arg="name">name=</button>
                        <button class="panel-button" data-selector-arg="tag">tag=</button>
                        <button class="panel-button" data-selector-arg="limit">limit=</button>
                        </div>
                </section>
                <hr style="margin: 15px 0;">
                <section>
                    <h4>Or Continue With Next Execute Subcommand</h4>
                    <div id="selector-next-execute-options-container" class="panel-button-grid">
                        </div>
                </section>
            </div>
            
            </div> </div> <div id="fullscreen-entity-list" class="fullscreen-list-container">
        <button class="fullscreen-list-back-button" data-action="close-fullscreen-list" data-target-panel-id="panel-selector-activated">X</button>
        <h3 class="fullscreen-list-header">Select Entity Type</h3>
        </div>

    <div id="fullscreen-run-command-list" class="fullscreen-list-container">
        <button class="fullscreen-list-back-button" data-action="close-fullscreen-list" data-target-panel-id="panel-execute-subcommands">X</button>
        <h3 class="fullscreen-list-header">Choose Command to Run</h3>
        </div>

    <div id="keypad-container">
        <input type="text" id="keypad-display" readonly placeholder="0">
        <button data-key="7">7</button> <button data-key="8">8</button> <button data-key="9">9</button> <button data-key="~">~</button>
        <button data-key="4">4</button> <button data-key="5">5</button> <button data-key="6">6</button> <button data-key=".">.</button>
        <button data-key="1">1</button> <button data-key="2">2</button> <button data-key="3">3</button> <button data-key="-">-</button>
        <button data-key=" " style="font-size: 0.8em;">Spc</button> <button data-key="0">0</button> <button data-key="backspace" style="font-size: 0.8em;">DEL</button> <button data-key="enter" style="font-size: 0.8em;" class="primary">OK</button>
    </div>

    <script>
        // --- DATA STORE (as before) ---
        const MINECRAFT_ENTITIES = [ /* your extensive list */
            "allay", "area_effect_cloud", "armor_stand", "arrow", "axolotl", "bat", "bee", "blaze", 
            "boat", "camel", "cat", "cave_spider", "chest_boat", "chicken", "cod", "cow", "creeper", /* ... and so on */
        ];
        const RUN_COMMANDS_LIST = [ /* your list */
            { id: "say", name: "say", nextPanelIdOrAction: "handleSayCommand" },
            { id: "tp", name: "tp (teleport)", nextPanelIdOrAction: "panel-run-tp-args-target" },
            { id: "summon", name: "summon", nextPanelIdOrAction: "handleSummonCommand" }, // Special handler
            /* ... more commands */
        ];

        // --- DOM ELEMENTS ---
        const commandBuiltArea = document.getElementById('command-built-area');
        // ... (other DOM elements as before)
        const mainPanelsContainer = document.querySelector('.button-panels-container');
        const fullscreenEntityList = document.getElementById('fullscreen-entity-list');
        const fullscreenRunCommandList = document.getElementById('fullscreen-run-command-list');
        const currentActiveSelectorDisplay = document.getElementById('current-active-selector-display');
        const selectorArgsOptionsContainer = document.getElementById('selector-args-options-container');
        const selectorNextExecuteOptionsContainer = document.getElementById('selector-next-execute-options-container');


        // --- STATE ---
        let commandParts = [];
        let currentPanelId = 'panel-initial';
        let activeInputTarget = null; // Stores the commandPart object that is waiting for input
        let pendingSelector = null; // Stores the selector chosen (e.g., "@e") before deciding on args or next command
        let isSelectorArgumentActive = false; // True if we are currently adding arguments to pendingSelector

        // --- INITIALIZATION ---
        function initialize() {
            showPanel('panel-initial'); // Show the main panel container first
            hideFullscreenLists();    // Ensure fullscreen lists are hidden
            populateRunCommandListForFullscreen(); // Populate the full-screen list
            populateEntityListForFullscreen();     // Populate the full-screen entity list
            // Clone execute subcommands for the selector-activated panel
            const execSubcommandsPanel = document.getElementById('panel-execute-subcommands').querySelector('.panel-button-grid');
            if (execSubcommandsPanel) {
                selectorNextExecuteOptionsContainer.innerHTML = execSubcommandsPanel.innerHTML;
            }
            setupEventListeners(); // Consolidated event listener setup
        }
        
        function hideFullscreenLists() {
            fullscreenEntityList.style.display = 'none';
            fullscreenRunCommandList.style.display = 'none';
        }

        function showFullscreenList(listId) {
            hideAllPanels(); // Hide main panels
            hideFullscreenLists(); // Hide other fullscreen lists
            if (listId === 'fullscreen-entity-list') fullscreenEntityList.style.display = 'flex';
            if (listId === 'fullscreen-run-command-list') fullscreenRunCommandList.style.display = 'flex';
            mainPanelsContainer.style.display = 'none'; // Hide the main panel area
        }

        function hideCurrentFullscreenListAndShowPanel(panelId) {
            hideFullscreenLists();
            mainPanelsContainer.style.display = 'block'; // Show main panel area again
            showPanel(panelId);
        }

        function populateEntityListForFullscreen() {
            const container = fullscreenEntityList; // Directly target the flex container
            // Clear existing except header and back button
            container.querySelectorAll('.list-item-button').forEach(btn => btn.remove());

            MINECRAFT_ENTITIES.sort().forEach(entity => {
                const button = document.createElement('button');
                button.className = 'list-item-button';
                button.textContent = entity;
                button.dataset.entityType = entity;
                button.addEventListener('click', () => handleEntityTypeSelection(entity));
                container.appendChild(button);
            });
        }
        
        function populateRunCommandListForFullscreen() {
            const container = fullscreenRunCommandList;
            container.querySelectorAll('.list-item-button').forEach(btn => btn.remove());

            RUN_COMMANDS_LIST.forEach(cmd => {
                const button = document.createElement('button');
                button.className = 'list-item-button';
                button.textContent = cmd.name;
                button.dataset.runCommand = cmd.id;
                button.dataset.nextAction = cmd.nextPanelIdOrAction; // Store action/panel
                button.addEventListener('click', () => handleRunCommandSelection(cmd));
                container.appendChild(button);
            });
        }

        // --- PANEL MANAGEMENT (showPanel remains similar, but interacts with fullscreen lists) ---
        function showPanel(panelId) {
            allPanels.forEach(panel => panel.style.display = 'none');
            const panelToShow = document.getElementById(panelId);
            if (panelToShow) {
                panelToShow.style.display = 'block';
                currentPanelId = panelId;
            } else {
                document.getElementById('panel-initial').style.display = 'block';
                currentPanelId = 'panel-initial';
            }
            keypadContainer.style.display = 'none';
        }

        // --- COMMAND BUILDING (addCommandSegment, renderCommandBuiltArea) ---
        // renderCommandBuiltArea needs to be careful NOT to add brackets/commas as distinct parts
        function addCommandSegment(text, type, options = {}) {
            // Ensure text doesn't include brackets or commas if they are handled implicitly
            const cleanText = text.replace(/[\[\],]/g, '');
            const segment = {
                id: `cmd-part-${Date.now()}-${Math.random().toString(36).substr(2, 5)}`,
                text: cleanText,
                type: type,
                hasBrackets: options.hasBrackets || false, // For selectors with arguments
                // ... other properties
                ...options
            };
            commandParts.push(segment);
            renderCommandBuiltArea();
            // ... (handleRequiredInput logic)
        }

        function renderCommandBuiltArea() {
            commandBuiltArea.innerHTML = '';
            let fullCommandStringForDisplay = ""; // Used to build the string with implicit parts

            commandParts.forEach((part, index) => {
                let partTextForButton = part.text;
                let prefix = "";
                let suffix = "";

                if (part.type === 'selector_base' && part.hasBrackets) {
                    partTextForButton = part.text + "["; // Display @e[
                }
                // Add comma before a new selector argument, if not the first
                if (part.type === 'selector_arg_key' && index > 0) {
                    // Check if the previous relevant part was also an argument value or key
                    let needsComma = false;
                    for (let j = index - 1; j >= 0; j--) {
                        if (commandParts[j].type === 'selector_base' && commandParts[j].hasBrackets) break; // Start of this selector's args
                        if (commandParts[j].type === 'selector_arg_value' || commandParts[j].type === 'selector_arg_key') {
                            needsComma = true;
                            break;
                        }
                    }
                    if (needsComma) prefix = ",";
                }
                
                const partBtn = document.createElement('button');
                partBtn.className = 'command-part-btn';
                partBtn.textContent = prefix + partTextForButton; // Add prefix here
                // Suffix (like ']') is handled by checking the *end* of selector arguments
                // or implicitly when moving to the next execute subcommand

                partBtn.dataset.partId = part.id;
                // ... (add event listener for change popup) ...
                commandBuiltArea.appendChild(partBtn);
            });

            // Check if the last segment was the end of selector arguments
            if (commandParts.length > 0) {
                const lastPart = commandParts[commandParts.length - 1];
                if (lastPart.type === 'selector_args_end_implicitly') { // A new flag or state
                    const bracketBtn = document.createElement('button');
                    bracketBtn.className = 'command-part-btn';
                    bracketBtn.textContent = ']';
                    bracketBtn.disabled = true; // Not interactive, just for display
                    commandBuiltArea.appendChild(bracketBtn);
                }
            }
        }
        
        // --- CHANGE POPUP (Adjust Y position) ---
        function showChangeOption(parentButton, partId, index) {
            // ... (previous logic to create popup) ...
            const popup = document.createElement('div'); // create as before
            popup.className = 'change-popup';
            popup.textContent = 'Change';
            // ... (event listener for change) ...
            parentButton.appendChild(popup);

            const parentRect = parentButton.getBoundingClientRect();
            const containerRect = commandBuiltArea.getBoundingClientRect();
            const popupRect = popup.getBoundingClientRect();

            if (parentRect.bottom + popupRect.height > containerRect.bottom) {
                popup.style.bottom = 'auto';
                popup.style.top = `-${popupRect.height + 2}px`; // Position above
            } else {
                popup.style.top = 'auto';
                popup.style.bottom = `-${popupRect.height + 2}px`; // Position below
            }
             // ... (rest of showChangeOption logic) ...
        }


        // --- EVENT LISTENERS SETUP ---
        function setupEventListeners() {
            document.getElementById('start-execute-button').addEventListener('click', () => {
                commandParts = []; pendingSelector = null; isSelectorArgumentActive = false;
                addCommandSegment('/execute', 'execute_start');
                showPanel('panel-execute-subcommands');
            });

            // --- SELECTOR ACTIVATED PANEL LOGIC ---
            // 1. When a selector is chosen from panel-targets (e.g., @e)
            document.querySelectorAll('#panel-targets .panel-button[data-selector]').forEach(button => {
                button.addEventListener('click', () => {
                    pendingSelector = button.dataset.selector;
                    isSelectorArgumentActive = false; // Reset
                    currentActiveSelectorDisplay.textContent = `Editing: ${pendingSelector}`;
                    showPanel('panel-selector-activated');
                });
            });

            // 2. Clicks within panel-selector-activated
            //    A. Clicking a selector argument (e.g., type=)
            selectorArgsOptionsContainer.addEventListener('click', (e) => {
                if (e.target.matches('.panel-button[data-selector-arg]')) {
                    if (!pendingSelector) return; // Should not happen

                    // If this is the FIRST argument for this pendingSelector, mark selector as having brackets
                    if (!isSelectorArgumentActive) {
                         // Add the base selector (e.g., @e) to command parts
                         addCommandSegment(pendingSelector, 'selector_base', { hasBrackets: true });
                         isSelectorArgumentActive = true;
                    }
                    const argKey = e.target.dataset.selectorArg;
                    addCommandSegment(argKey + "=", 'selector_arg_key', {originalCommand: argKey}); // e.g., type=

                    // Proceed to get value for this argument
                    if (argKey === 'type') {
                        activeInputTarget = commandParts[commandParts.length - 1]; // The "type=" part (or its value placeholder)
                        showFullscreenList('fullscreen-entity-list');
                    } else if (argKey === 'limit' /* other numeric args */) {
                        addCommandSegment(`[${argKey} val]`, 'selector_arg_value', {isPlaceholder:true, requiresInput:'keypad_number', placeholder:'Enter number', originalCommand: argKey, nextPanelAfterInput:'panel-selector-activated'});
                    } else { // Default to text for name, tag etc.
                        addCommandSegment(`[${argKey} val]`, 'selector_arg_value', {isPlaceholder:true, requiresInput:'text_input', placeholder:'Enter value...', originalCommand: argKey, nextPanelAfterInput:'panel-selector-activated'});
                    }
                }
            });

            // B. Clicking a next execute subcommand (e.g., run) INSTEAD of an argument
            selectorNextExecuteOptionsContainer.addEventListener('click', (e) => {
                if (e.target.matches('.panel-button[data-subcommand]')) {
                    if (!pendingSelector) return;

                    if (isSelectorArgumentActive) { // Arguments were being added
                        // Implicitly end selector arguments (add a conceptual ']')
                         addCommandSegment('', 'selector_args_end_implicitly'); // Will trigger ']' in render
                        isSelectorArgumentActive = false;
                    } else {
                        // Selector was chosen, but no args were added, so add selector plain
                        addCommandSegment(pendingSelector, 'selector_base', { hasBrackets: false });
                    }
                    
                    const subcommand = e.target.dataset.subcommand;
                    addCommandSegment(subcommand, 'execute_subcommand'); // Add the chosen subcommand
                    pendingSelector = null; // Reset pending selector

                    // Transition to the panel for this new subcommand (e.g., panel-run-command-choice if 'run')
                    const nextPanel = getNextPanelForExecuteSubcommand(subcommand);
                    showPanel(nextPanel);
                }
            });
            
            // Back buttons for fullscreen lists
            document.querySelectorAll('.fullscreen-list-back-button').forEach(button => {
                button.addEventListener('click', () => {
                    const targetPanel = button.dataset.targetPanelId || 'panel-execute-subcommands'; // Fallback
                    hideCurrentFullscreenListAndShowPanel(targetPanel);
                     // If we were selecting a value for a pending selector arg, stay in selector mode
                    if (pendingSelector && activeInputTarget && activeInputTarget.type === 'selector_arg_key') {
                         showPanel('panel-selector-activated'); // Keep options for this selector
                    }
                });
            });
            
             // --- SUMMON COMMAND ---
            // This is now part of handleRunCommandSelection
            // function handleSummonCommand() { // Called when "summon" is chosen from run commands
            //     showFullscreenList('fullscreen-entity-list');
            //     // The handleEntityTypeSelection will need context that it's for a summon command
            // }
            // Modified handleEntityTypeSelection
            function handleEntityTypeSelection(entityType) {
                // Determine context: is it for a selector 'type=' or for 'summon'?
                if (activeInputTarget && activeInputTarget.type === 'selector_arg_key' && activeInputTarget.originalCommand === 'type') {
                    // It's for selector type=
                    // Find the actual placeholder segment if one was made, or update activeInputTarget
                    let valueSegment = commandParts.find(p => p.isPlaceholder && p.id === activeInputTarget.valuePlaceholderId);
                    if(valueSegment) {
                        valueSegment.text = entityType;
                        valueSegment.isPlaceholder = false;
                    } else { // if type= was just added, and now entity is chosen
                         addCommandSegment(entityType, 'selector_arg_value');
                    }
                    renderCommandBuiltArea();
                    activeInputTarget = null;
                    hideCurrentFullscreenListAndShowPanel('panel-selector-activated');
                } else if (currentPanelId === 'fullscreen-entity-list' && commandParts.length > 0 && commandParts[commandParts.length-1].text === 'summon') {
                    // It's for a summon command
                    addCommandSegment(entityType, 'entity_type_for_summon'); // Add "pig", "cow" etc.
                    renderCommandBuiltArea();
                    // Now transition to get summon's next arguments (pos, nbt)
                    // e.g. addCommandSegment("[pos]", "placeholder", {requiresInput: "keypad_coordinates"})
                    //      showKeypad...
                    // For now, just go back to generic execute options to simplify
                    hideCurrentFullscreenListAndShowPanel('panel-execute-subcommands'); // Placeholder for actual summon args panel
                    // TODO: Create panel-summon-args for position (keypad) and NBT (text input)
                }
            }


            // Other event listeners (main execute subcommands, copy, keypad, etc.)
            // Need to be adapted. For example, clicking 'as' in panel-execute-subcommands:
            document.querySelectorAll('#panel-execute-subcommands .panel-button[data-subcommand]').forEach(button => {
                 button.addEventListener('click', () => {
                    const subcommand = button.dataset.subcommand;
                    // If a selector was active and arguments were being added, end them.
                    if (isSelectorArgumentActive && pendingSelector) {
                        addCommandSegment('', 'selector_args_end_implicitly');
                        isSelectorArgumentActive = false;
                        pendingSelector = null;
                    }
                    addCommandSegment(subcommand, 'execute_subcommand');
                    const nextPanel = getNextPanelForExecuteSubcommand(subcommand);
                    showPanel(nextPanel);
                 });
            });
            
            // Helper to decide next panel
            function getNextPanelForExecuteSubcommand(subcommand) {
                switch (subcommand) {
                    case 'as': case 'at': return 'panel-targets';
                    case 'in': return 'panel-dimensions';
                    case 'run': showFullscreenList('fullscreen-run-command-list'); return currentPanelId; // Stay on current, fullscreen overlays
                    // TODO: positioned, rotated, facing -> trigger keypad
                    // TODO: if, unless -> conditional panels
                    default: return 'panel-execute-subcommands'; // Default loop back
                }
            }
            
            // Modified handleRunCommandSelection
            function handleRunCommandSelection(commandInfo) {
                addCommandSegment(commandInfo.id, 'run_command_name');
                pendingSelector = null; isSelectorArgumentActive = false; // Clear any selector state

                if (commandInfo.id === 'summon') {
                    activeInputTarget = null; // Clear any prior target
                    // Context for entity selection will be handled by checking last command part
                    hideCurrentFullscreenListAndShowPanel(null); // Hide run command list
                    showFullscreenList('fullscreen-entity-list'); // Show entity list for summon
                } else if (commandInfo.id === 'say') {
                     addCommandSegment('[message]', 'run_command_arg', {isPlaceholder:true, requiresInput:'text_input', placeholder:'Type message...', nextPanelAfterInput:'panel-execute-subcommands'});
                     hideCurrentFullscreenListAndShowPanel('panel-execute-subcommands'); // Or wherever 'say' finishes
                }
                // ... other run commands
                else if (typeof commandInfo.nextPanelIdOrAction === 'string' && commandInfo.nextPanelIdOrAction.startsWith('panel-')) {
                    hideCurrentFullscreenListAndShowPanel(commandInfo.nextPanelIdOrAction);
                } else {
                    hideCurrentFullscreenListAndShowPanel('panel-execute-subcommands'); // Fallback
                }
            }

             // Make sure to actually use these functions in the event listeners
             window.handleEntityTypeSelection = handleEntityTypeSelection;
             window.handleRunCommandSelection = handleRunCommandSelection;

        } // End setupEventListeners

        // --- START THE APP ---
        initialize();
    </script>
</body>
</html>
