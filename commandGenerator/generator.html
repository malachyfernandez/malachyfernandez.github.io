<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Minecraft Command Generator Pro (Keypad Enhanced)</title>
    <style>
        /* Base styles from previous version */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0; 
            margin: 0;
            background-color: #f0f2f5;
            color: #1c1e21;
            overscroll-behavior-y: contain;
            height: 100vh;
            width: 100vw;
            overflow: hidden; 
        }
        #main-container {
            width: 100%;
            max-width: 500px; 
            margin: 0 auto; 
            display: flex;
            flex-direction: column;
            height: 100%; 
            box-sizing: border-box;
            padding: 10px; 
        }
        #command-display-area {
            background-color: #fff;
            border: 1px solid #ccd0d5;
            border-radius: 8px;
            padding: 8px;
            margin-bottom: 10px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            flex-shrink: 0; 
        }
        #command-built-area {
            flex-grow: 1;
            min-height: 48px;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 4px;
            overflow-y: auto;
            max-height: 100px;
            padding-bottom: 5px; 
        }
        .command-part-btn, .command-part-char-display, .command-part-input-wrapper input {
            padding: 6px 10px;
            background-color: #e4e6eb;
            color: #050505;
            border: 1px solid #d1d3d6;
            border-radius: 15px;
            font-size: 0.9em;
            position: relative; 
            box-sizing: border-box;
            line-height: 1.2;
            white-space: nowrap;
        }
        .command-part-btn {
            cursor: pointer;
        }
        .command-part-btn:hover { background-color: #d8dbdf; }

        .command-part-char-display {
            background-color: #f0f2f5;
            cursor: default;
            padding: 6px 8px;
        }
        
        .command-part-input-wrapper {
            display: inline-block;
            padding: 0; margin:0; border:none; background:none;
        }
        .command-part-input-wrapper input {
            background-color: #fff; 
            border: 1px solid #1b74e4; 
            min-width: 60px; 
            max-width: 150px; 
            outline: none;
        }
        .command-part-input-wrapper input[readonly] { /* For keypad-driven inputs */
             background-color: #eef1f5; /* Slightly different to indicate it's keypad driven */
             cursor: pointer;
        }


        .change-popup { 
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333; color: white; padding: 5px 10px;
            border-radius: 4px; z-index: 1000; cursor: pointer; font-size: 0.8em;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            white-space: nowrap;
        }

        #copy-button {
            padding: 12px 15px; margin-left: 8px; background-color: #1b74e4;
            color: white; border: none; border-radius: 6px; cursor: pointer;
            font-size: 0.9em; font-weight: bold;
        }
        #copy-button:hover { background-color: #155bd8; } 

        .button-panels-container { 
            flex-grow: 1;
            overflow-y: auto;
            background-color: #ffffff;
            border: 1px solid #ccd0d5;
            border-radius: 8px;
            padding: 10px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .button-panel { margin-bottom: 15px; }
        .button-panel h3 {
            margin-top: 0; margin-bottom: 10px; font-size: 1.1em; color: #606770;
            border-bottom: 1px solid #e4e6eb; padding-bottom: 5px;
        }

        .panel-button-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 8px;
        }
        .panel-button-list { display: flex; flex-direction: column; gap: 8px; }

        .panel-button { 
            padding: 12px 10px; background-color: #f0f2f5; color: #050505;
            border: 1px solid #d1d3d6; border-radius: 6px; cursor: pointer;
            text-align: center; font-size: 0.95em; transition: background-color 0.2s;
        }
        .panel-button:hover { background-color: #e4e6eb; }
        .panel-button.primary { background-color: #1b74e4; color: white; font-weight: bold; }
        .panel-button.primary:hover { background-color: #155bd8; } 

        .fullscreen-list-container {
            position: fixed; 
            top: 0; left: 0; width: 100vw; height: 100vh;
            background-color: #fff;
            z-index: 2000; 
            padding: 10px;
            box-sizing: border-box;
            overflow-y: auto; 
            display: flex; 
            flex-wrap: wrap; 
            gap: 6px; 
            align-content: flex-start; 
        }
        .fullscreen-list-container .list-item-button { 
            padding: 6px 12px;
            background-color: #e4e6eb;
            color: #050505;
            border: 1px solid #d1d3d6;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.9em;
        }
         .fullscreen-list-container .list-item-button:hover { background-color: #d8dbdf; }
         .fullscreen-list-header { 
            width: 100%;
            padding: 10px 0;
            font-size: 1.2em;
            font-weight: bold;
            text-align: center;
            margin-bottom: 10px;
            flex-basis: 100%; 
         }
         .fullscreen-list-back-button {
            position: fixed;
            top: 15px; right: 15px;
            z-index: 2001; 
            padding: 8px 12px;
            background-color: #050505;
            color: white;
            border: none;
            border-radius: 50%; 
            font-size: 1em;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
         }

        #keypad-container {
            position: fixed; bottom: 0; left: 0; right: 0;
            background-color: #d1d3d6; padding: 10px; border-top: 1px solid #b0b3b8;
            box-shadow: 0 -2px 5px rgba(0,0,0,0.1); z-index: 1000;
            display: none; 
            grid-template-columns: repeat(4, 1fr); gap: 5px;
        }
        #keypad-container button {
            padding: 15px 10px; font-size: 1.2em; background-color: #f0f2f5;
            border: 1px solid #b0b3b8; border-radius: 5px; cursor: pointer;
        }
        #keypad-container button:active { background-color: #b0b3b8; }
        #keypad-display {
            grid-column: span 4; background-color: #fff; border: 1px solid #b0b3b8;
            padding: 10px; text-align: right; font-size: 1.2em; margin-bottom: 5px; min-height: 24px;
        }

        .button-panel:not(#panel-initial) { display: none; }
        .fullscreen-list-container { display: none; } 

    </style>
</head>
<body>
    <div id="main-container">
        <div id="command-display-area">
            <div id="command-built-area"></div>
            <button id="copy-button">Copy</button>
        </div>

        <div class="button-panels-container">
            <div id="panel-initial" class="button-panel">
                <div class="panel-button-list">
                    <button id="start-execute-button" class="panel-button primary">Start with /execute</button>
                </div>
            </div>

            <div id="panel-execute-subcommands" class="button-panel">
                <h3>Execute Subcommands</h3>
                <div class="panel-button-grid">
                    <button class="panel-button" data-subcommand="as">as</button>
                    <button class="panel-button" data-subcommand="at">at</button>
                    <button class="panel-button" data-subcommand="in">in</button>
                    <button class="panel-button" data-subcommand="positioned">positioned</button>
                    <button class="panel-button" data-subcommand="align">align</button>
                    <button class="panel-button" data-subcommand="anchored">anchored</button>
                    <button class="panel-button" data-subcommand="rotated">rotated</button>
                    <button class="panel-button" data-subcommand="facing">facing</button>
                    <button class="panel-button" data-subcommand="if">if</button>
                    <button class="panel-button" data-subcommand="unless">unless</button>
                    <button class="panel-button primary" data-subcommand="run">run</button>
                </div>
            </div>

            <div id="panel-targets" class="button-panel">
                <h3>Target Selectors</h3>
                <div class="panel-button-grid">
                    <button class="panel-button" data-selector="@p">@p</button>
                    <button class="panel-button" data-selector="@r">@r</button>
                    <button class="panel-button" data-selector="@a">@a</button>
                    <button class="panel-button" data-selector="@s">@s</button>
                    <button class="panel-button" data-selector="@e">@e</button>
                    <button class="panel-button" data-action="manual-selector-entry">[Type Selector/Name]</button>
                </div>
            </div>
            
            <div id="panel-selector-activated" class="button-panel">
                <h3>Selector Active: <span id="current-active-selector-display" style="font-weight:bold;"></span></h3>
                <section>
                    <h4>Add Argument</h4>
                    <div id="selector-args-options-container" class="panel-button-grid">
                        <button class="panel-button" data-selector-arg-key="type">type=</button>
                        <button class="panel-button" data-selector-arg-key="name">name=</button>
                        <button class="panel-button" data-selector-arg-key="tag">tag=</button>
                        <button class="panel-button" data-selector-arg-key="limit">limit=</button>
                        </div>
                </section>
                <hr style="margin: 15px 0;">
                <section>
                    <h4>Or Continue With Next Subcommand</h4>
                    <div id="selector-next-execute-options-container" class="panel-button-grid">
                        </div>
                </section>
            </div>
            
            <div id="panel-dimensions" class="button-panel">
                 <h3>Dimension</h3>
                 <div class="panel-button-grid">
                    <button class="panel-button" data-dimension="overworld">overworld</button>
                    <button class="panel-button" data-dimension="the_nether">the_nether</button>
                    <button class="panel-button" data-dimension="the_end">the_end</button>
                </div>
            </div>

            </div> </div> <div id="fullscreen-entity-list" class="fullscreen-list-container">
        <button class="fullscreen-list-back-button" data-action="close-fullscreen-list">X</button>
        <h3 class="fullscreen-list-header">Select Entity Type</h3>
        </div>

    <div id="fullscreen-run-command-list" class="fullscreen-list-container">
        <button class="fullscreen-list-back-button" data-action="close-fullscreen-list">X</button>
        <h3 class="fullscreen-list-header">Choose Command to Run</h3>
        </div>

    <div id="keypad-container">
        <input type="text" id="keypad-display" readonly placeholder="0">
        <button data-key="7">7</button> <button data-key="8">8</button> <button data-key="9">9</button> <button data-key="~">~</button>
        <button data-key="4">4</button> <button data-key="5">5</button> <button data-key="6">6</button> <button data-key=".">.</button>
        <button data-key="1">1</button> <button data-key="2">2</button> <button data-key="3">3</button> <button data-key="-">-</button>
        <button data-key=" " style="font-size: 0.8em;">Space/Next</button> <button data-key="0">0</button> <button data-key="backspace" style="font-size: 0.8em;">DEL</button> <button data-key="enter" style="font-size: 0.8em;" class="primary">OK</button>
    </div>

    <script>
        // --- DATA STORE ---
        const MINECRAFT_ENTITIES = ["allay", "armor_stand", /* ... a_very_long_list_here ... */ "zombified_piglin"];
        const RUN_COMMANDS_LIST = [
            { id: "say", name: "say", handler: "handleSayCommand" },
            { id: "tp", name: "tp", handler: "handleTpCommand" },
            { id: "summon", name: "summon", handler: "handleSummonCommand" },
            // ... more commands
        ];

        // --- DOM ELEMENTS ---
        const commandBuiltArea = document.getElementById('command-built-area');
        const allPanels = document.querySelectorAll('.button-panel');
        const copyButton = document.getElementById('copy-button');
        const mainPanelsContainer = document.querySelector('.button-panels-container');
        const fullscreenEntityList = document.getElementById('fullscreen-entity-list');
        const fullscreenRunCommandList = document.getElementById('fullscreen-run-command-list');
        const currentActiveSelectorDisplay = document.getElementById('current-active-selector-display');
        const selectorArgsOptionsContainer = document.getElementById('selector-args-options-container');
        const selectorNextExecuteOptionsContainer = document.getElementById('selector-next-execute-options-container');
        const keypadContainer = document.getElementById('keypad-container');
        const keypadDisplay = document.getElementById('keypad-display');

        // --- STATE ---
        let commandParts = [];
        let currentPanelId = 'panel-initial';
        let activeInputTarget = null; // Object: { partId, inputType, currentIndex, values[], placeholder, nextPanelAfterInput, sourcePanelId, targetCommandPart }
        let pendingSelector = null; 
        let selectorArgState = {
            isActive: false,
            baseSelectorPartId: null,
            hasOpenBracket: false
        };

        // --- INITIALIZATION ---
        function initialize() {
            showPanel('panel-initial'); 
            hideFullscreenLists();    
            populateRunCommandListForFullscreen(); 
            populateEntityListForFullscreen();     
            const execSubcommandsPanelGrid = document.getElementById('panel-execute-subcommands').querySelector('.panel-button-grid');
            if (execSubcommandsPanelGrid) {
                selectorNextExecuteOptionsContainer.innerHTML = execSubcommandsPanelGrid.innerHTML;
            }
            setupEventListeners(); 
        }
        
        // --- Fullscreen List & Panel Management (mostly same as before) ---
        function hideFullscreenLists() { /* ... */ }
        function showFullscreenList(listId, context = {}) { /* ... */ }
        function hideCurrentFullscreenListAndShowPanel(panelId) { /* ... */ }
        function populateEntityListForFullscreen() { /* ... ensure click calls handleEntityTypeSelection ... */ }
        function populateRunCommandListForFullscreen() { /* ... ensure click calls handleRunCommandSelection ... */ }
        function showPanel(panelId) { /* ... */ }
        // (Copy these functions from the previous complete code block you liked)
        // For brevity, I'll omit the exact same code for these helper functions here.
        // Just make sure they are present and work as before.
        // The key is they are called correctly.

        // --- COMMAND BUILDING & RENDERING ---
        function addCommandSegment(text, type, options = {}) {
            const segment = {
                id: `cmd-part-${Date.now()}-${Math.random().toString(36).substr(2, 5)}`,
                text: options.isEditableInput && !text ? (options.placeholder || `[${type}]`) : text,
                type: type,
                isEditableInput: options.isEditableInput || false,
                placeholder: options.placeholder || "",
                requiresInput: options.requiresInput || null, // 'keypad_coordinates', 'keypad_number', 'text'
                sourcePanelId: currentPanelId,
                ...options
            };
            commandParts.push(segment);
            renderCommandBuiltArea();
            
            // If an editable input was just added, and it's keypad driven, auto-prepare if desired.
            // However, the user now clicks the placeholder to activate keypad.
            return segment;
        }

        function renderCommandBuiltArea() {
            commandBuiltArea.innerHTML = '';
            commandParts.forEach((part, index) => {
                let element;
                if (part.isEditableInput) {
                    const wrapper = document.createElement('div'); 
                    wrapper.className = 'command-part-input-wrapper';
                    element = document.createElement('input');
                    element.type = 'text';
                    element.value = part.text; // Display current text (e.g. "[x y z]" or "10 ~ 20")
                    element.placeholder = part.placeholder || 'value';
                    element.dataset.partId = part.id;
                    element.dataset.partIndex = index;
                    
                    element.addEventListener('input', (e) => { // For regular text inputs
                        if (part.requiresInput !== 'keypad_coordinates' && part.requiresInput !== 'keypad_number') {
                            part.text = e.target.value;
                        }
                    });

                    if (part.requiresInput && part.requiresInput.startsWith('keypad')) {
                        element.readOnly = true; 
                        element.addEventListener('click', () => prepareKeypadForInput(part));
                    }
                    wrapper.appendChild(element);
                    commandBuiltArea.appendChild(wrapper);
                } else if (['bracket_open', 'bracket_close', 'comma'].includes(part.type)) {
                    element = document.createElement('span');
                    element.className = 'command-part-char-display';
                    element.textContent = part.text;
                    element.dataset.partId = part.id;
                    commandBuiltArea.appendChild(element);
                } else { 
                    element = document.createElement('button');
                    element.className = 'command-part-btn';
                    element.textContent = part.text;
                    element.dataset.partId = part.id;
                    element.dataset.partIndex = index;
                    element.addEventListener('click', (e) => {
                        e.stopPropagation(); 
                        showChangeOption(element, part.id, index);
                    });
                    commandBuiltArea.appendChild(element);
                }
            });
        }
        
        // --- Change Popup Logic (same as before, check bounds) ---
        let currentChangePopup = null;
        function showChangeOption(parentButtonOrInput, partId, index) { /* ... same ... */ }
        function handleChangeCommandPart(index) { /* ... Needs careful implementation ... */ }


        // --- KEYPAD LOGIC (ENHANCED FOR COORDINATES) ---
        function prepareKeypadForInput(partData) {
            if (!partData || !partData.requiresInput || !partData.requiresInput.startsWith('keypad')) return;

            let initialValues = ["", "", ""];
            if (partData.text && partData.text !== partData.placeholder) {
                const splitValues = partData.text.split(' ');
                for(let i=0; i<3; i++) {
                    initialValues[i] = splitValues[i] || "";
                }
            }

            activeInputTarget = {
                partId: partData.id,
                inputType: partData.requiresInput, 
                currentIndex: 0,      
                values: initialValues,
                placeholder: partData.placeholder || (partData.requiresInput === 'keypad_coordinates' ? 'X Y Z' : 'Enter value'),
                nextPanelAfterInput: partData.nextPanelAfterInput,
                sourcePanelId: partData.sourcePanelId,
                targetCommandPart: partData 
            };
            
            updateKeypadDisplayForCurrentCoordinate();
            keypadContainer.style.display = 'grid';
        }

        function updateKeypadDisplayForCurrentCoordinate() {
            if (!activeInputTarget) return;
            const coordLabels = ["X", "Y", "Z"];
            if (activeInputTarget.inputType === 'keypad_coordinates') {
                keypadDisplay.placeholder = `${coordLabels[activeInputTarget.currentIndex]}: ${activeInputTarget.values[activeInputTarget.currentIndex] || '~'}`;
                keypadDisplay.value = activeInputTarget.values[activeInputTarget.currentIndex] || "";
            } else { // For keypad_number
                keypadDisplay.placeholder = activeInputTarget.placeholder;
                keypadDisplay.value = activeInputTarget.values[0] || ""; // Assumes single value for keypad_number
            }
        }


        function handleKeypadInput(key) {
            if (!activeInputTarget || !activeInputTarget.targetCommandPart) return;

            const currentValIndex = activeInputTarget.currentIndex;
            let currentDisplayValue = keypadDisplay.value;

            switch (key) {
                case 'enter': 
                    activeInputTarget.values[currentValIndex] = currentDisplayValue.trim();
                    activeInputTarget.targetCommandPart.text = activeInputTarget.values.join(' ').trim();
                    activeInputTarget.targetCommandPart.isPlaceholder = false; 
                    
                    renderCommandBuiltArea();
                    keypadContainer.style.display = 'none';
                    
                    const nextPanel = activeInputTarget.nextPanelAfterInput;
                    activeInputTarget = null; 
                    
                    if (nextPanel) showPanel(nextPanel);
                    else if (selectorArgState.isActive) showPanel('panel-selector-activated');
                    else showPanel('panel-execute-subcommands');
                    break;

                case 'backspace':
                    currentDisplayValue = currentDisplayValue.slice(0, -1);
                    keypadDisplay.value = currentDisplayValue;
                    activeInputTarget.values[currentValIndex] = currentDisplayValue;
                    activeInputTarget.targetCommandPart.text = activeInputTarget.values.join(' ').trim();
                    // No renderCommandBuiltArea here to avoid flicker while typing
                    break;
                
                case ' ': // Space key for "Next Coordinate"
                    if (activeInputTarget.inputType === 'keypad_coordinates') {
                        activeInputTarget.values[currentValIndex] = currentDisplayValue.trim() || "~"; 
                        activeInputTarget.currentIndex++;
                        if (activeInputTarget.currentIndex > 2) { 
                            activeInputTarget.currentIndex = 0; 
                        }
                        activeInputTarget.targetCommandPart.text = activeInputTarget.values.join(' ').trim();
                        renderCommandBuiltArea(); // Update the command bar display
                        updateKeypadDisplayForCurrentCoordinate();
                    } else { 
                        currentDisplayValue += ' ';
                        keypadDisplay.value = currentDisplayValue;
                        activeInputTarget.values[0] = currentDisplayValue; // Assuming single value for non-coord
                        activeInputTarget.targetCommandPart.text = currentDisplayValue.trim();
                    }
                    break;

                default: // Number or '~'
                    if (key === '~' && activeInputTarget.inputType === 'keypad_coordinates') {
                        currentDisplayValue += key;
                    } else if (key === '~' && !currentDisplayValue.includes('~')) { // Allow only one leading ~ for non-coord numbers
                        currentDisplayValue = key + currentDisplayValue;
                    } else if (key !== '~') { // Regular numbers/dot
                         currentDisplayValue += key;
                    }
                    keypadDisplay.value = currentDisplayValue;
                    activeInputTarget.values[currentValIndex] = currentDisplayValue;
                    activeInputTarget.targetCommandPart.text = activeInputTarget.values.join(' ').trim();
                    break;
            }
        }
        
        function setupKeypadListeners() {
            if (!keypadContainer) return;
            keypadContainer.addEventListener('click', function(e) {
                if (e.target.tagName === 'BUTTON' && e.target.dataset.key) {
                     handleKeypadInput(e.target.dataset.key);
                }
            });
        }


        // --- EVENT LISTENERS & LOGIC FLOW (Many parts are similar to before) ---
        function setupEventListeners() {
            // Start Execute Button
            document.getElementById('start-execute-button').addEventListener('click', () => { /* ... same ... */ });
            
            // Panel Targets (Selectors like @e)
            document.querySelectorAll('#panel-targets .panel-button[data-selector]').forEach(button => { /* ... same ... */ });
            
            // Panel Selector Activated (Args and Next Execute)
            // ... (Ensure this logic now adds explicit bracket/comma parts to commandParts) ...
            // ... (And when choosing next execute, closes bracket if open) ...

            // Main Execute Subcommands Panel
            document.querySelectorAll('#panel-execute-subcommands .panel-button[data-subcommand]').forEach(button => {
                 button.addEventListener('click', () => {
                    const subcommand = button.dataset.subcommand;
                    if (selectorArgState.isActive && selectorArgState.hasOpenBracket) {
                        addCommandSegment(']', 'bracket_close'); // Explicitly close
                    }
                    selectorArgState = { isActive: false, baseSelectorPartId: null, hasOpenBracket: false };
                    pendingSelector = null;

                    addCommandSegment(subcommand, 'keyword');
                    const nextPanel = getNextPanelForExecuteSubcommand(subcommand); // This is now key
                    if (nextPanel && nextPanel !== currentPanelId) { // Only show if it's a new panel
                        showPanel(nextPanel);
                    } else if (!nextPanel && subcommand !== 'positioned' && subcommand !== 'rotated' && subcommand !== 'facing' && subcommand !== 'align') {
                        // If no specific next panel, and not a command that adds an input in-place
                        showPanel('panel-execute-subcommands'); // Default loop back
                    }
                    // If it was 'positioned' etc., getNextPanelForExecuteSubcommand already added the placeholder
                    // and returned currentPanelId, so no showPanel() call is needed here for those cases.
                 });
            });

            // Fullscreen List Back Buttons
            document.querySelectorAll('.fullscreen-list-back-button').forEach(button => { /* ... same ... */ });
            
            // Copy Button
            copyButton.addEventListener('click', () => { /* ... needs to correctly join part.text ... */ });
            
            setupKeypadListeners(); // Make sure this is called
            attachListenersToSelectorNextExecuteOptions(); // For panel-selector-activated
             // Other listeners (dimensions, etc.)
        } 
        
        // --- Helper: Get Next Panel (Modified for positioned) ---
        function getNextPanelForExecuteSubcommand(subcommand) {
            switch (subcommand) {
                case 'as': case 'at': return 'panel-targets';
                case 'in': return 'panel-dimensions';
                case 'run': 
                    showFullscreenList('fullscreen-run-command-list'); 
                    return currentPanelId; 

                case 'positioned':
                case 'rotated': 
                case 'facing':
                    const placeholderText = subcommand === 'rotated' ? '[yaw pitch]' : '[x y z]';
                    addCommandSegment(placeholderText, `${subcommand}_coord_input`, { 
                        isEditableInput: true,
                        requiresInput: 'keypad_coordinates', 
                        placeholder: placeholderText.slice(1,-1), // Remove brackets for placeholder
                        nextPanelAfterInput: 'panel-execute-subcommands'
                    });
                    return currentPanelId; // Stay on current, keypad triggered by clicking the new part

                case 'align':
                    addCommandSegment('[axes]', 'align_axes_input', { 
                        isEditableInput: true, 
                        requiresInput: 'text', // Regular text input for align
                        placeholder: 'xyz', 
                        nextPanelAfterInput: 'panel-execute-subcommands' 
                    });
                    return currentPanelId;
                default: return 'panel-execute-subcommands'; 
            }
        }
        
        // --- Specific Handlers (handleEntityTypeSelection, handleRunCommandSelection) ---
        // These need to be robust.
        function handleEntityTypeSelection(entityType) { /* ... same, ensures correct panel return ... */ }
        function handleRunCommandSelection(commandInfo) { /* ... same ... */ }
        // (Make sure these functions are fully defined and correctly interact with states)


        // --- Placeholder for attachListenersToSelectorNextExecuteOptions ---
        function attachListenersToSelectorNextExecuteOptions() {
             selectorNextExecuteOptionsContainer.querySelectorAll('.panel-button[data-subcommand]').forEach(button => {
                const newButton = button.cloneNode(true); 
                button.parentNode.replaceChild(newButton, button);
                newButton.addEventListener('click', () => {
                    handleNextExecuteSubcommandFromSelectorPanel(newButton.dataset.subcommand);
                });
            });
        }
        function handleNextExecuteSubcommandFromSelectorPanel(subcommandName) { /* ... Logic as discussed before ... */ }
        // (Ensure these functions are fully defined)


        // --- START THE APP ---
        initialize();

        // --- TEMPORARY: Populate missing functions for script to run without breaking ---
        // Replace these with their actual implementations from previous versions or new logic
        if (typeof populateEntityListForFullscreen !== 'function') populateEntityListForFullscreen = function(){ console.warn("populateEntityListForFullscreen stub"); };
        if (typeof populateRunCommandListForFullscreen !== 'function') populateRunCommandListForFullscreen = function(){ console.warn("populateRunCommandListForFullscreen stub"); };
        if (typeof hideFullscreenLists !== 'function') hideFullscreenLists = function(){ console.warn("hideFullscreenLists stub"); };
        if (typeof showFullscreenList !== 'function') showFullscreenList = function(){ console.warn("showFullscreenList stub"); };
        if (typeof hideCurrentFullscreenListAndShowPanel !== 'function') hideCurrentFullscreenListAndShowPanel = function(){ console.warn("hideCurrentFullscreenListAndShowPanel stub"); };
        if (typeof handleEntityTypeSelection !== 'function') handleEntityTypeSelection = function(e){ console.warn("handleEntityTypeSelection stub", e); };
        if (typeof handleRunCommandSelection !== 'function') handleRunCommandSelection = function(e){ console.warn("handleRunCommandSelection stub", e); };
        if (typeof handleChangeCommandPart !== 'function') handleChangeCommandPart = function(idx){ console.warn("handleChangeCommandPart stub", idx); };
        if (typeof handleNextExecuteSubcommandFromSelectorPanel !== 'function') handleNextExecuteSubcommandFromSelectorPanel = function(cmd){ console.warn("handleNextExecuteSubcommandFromSelectorPanel stub", cmd); };


    </script>
</body>
</html>
